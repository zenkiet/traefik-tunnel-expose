name: ğŸ” PR Security & Validation Check

on:
  pull_request:
    branches: [ develop ]

jobs:
  security-validation:
    name: ğŸ” Security & Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ” Run Gitleaks for secrets detection
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ” Validate Docker Compose
        run: |
          docker-compose config

      - name: ğŸ“Š PR Summary
        run: |
          echo "## ğŸ” PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Security scan completed**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Docker Compose validation passed**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Environment configuration validated**" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“± Send Gotify notification - PR Success
        if: success()
        run: |
          curl -X POST "https://gotify.zenkiet.dev/message?token=${{ secrets.GOTIFY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "âœ… PR Validation Passed - Traefik Tunnel Expose",
              "message": "ğŸ” PR validation completed successfully!\n\nğŸ“‹ PR: #${{ github.event.number }}\nğŸŒ¿ Branch: ${{ github.head_ref }}\nğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}\nğŸ“ Title: ${{ github.event.pull_request.title }}\nğŸ”— PR: ${{ github.event.pull_request.html_url }}",
              "priority": 3
            }'

      - name: ğŸ“± Send Gotify notification - PR Failed
        if: failure()
        run: |
          curl -X POST "https://gotify.zenkiet.dev/message?token=${{ secrets.GOTIFY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "âŒ PR Validation Failed - Traefik Tunnel Expose",
              "message": "ğŸš¨ PR validation failed!\n\nğŸ“‹ PR: #${{ github.event.number }}\nğŸŒ¿ Branch: ${{ github.head_ref }}\nğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}\nğŸ“ Title: ${{ github.event.pull_request.title }}\nğŸ”— PR: ${{ github.event.pull_request.html_url }}\nğŸ“‹ Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "priority": 7
            }' 